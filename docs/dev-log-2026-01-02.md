# 개발 일지 - 2026년 1월 2일

## 주요 작업 내용

### 1. 쿠팡 로켓그로스 API 연동 구현

쿠팡 로켓그로스 Open API를 연동하여 주문/상품/재고 동기화 기능을 구현했습니다.

#### 구현 파일
- `apps/dashboard/app/features/integrations/lib/coupang.server.ts` - API 클라이언트
- `apps/dashboard/app/features/integrations/api/coupang-auth-save.tsx` - 인증 정보 저장
- `apps/dashboard/app/features/integrations/api/coupang-sync-orders.tsx` - 주문 동기화
- `apps/dashboard/app/features/integrations/api/coupang-sync-products.tsx` - 상품 동기화
- `apps/dashboard/app/features/integrations/api/coupang-sync-inventory.tsx` - 재고 동기화
- `apps/dashboard/app/features/integrations/screens/coupang-status.tsx` - 연동 관리 UI

#### 기술 스택
- **인증**: HMAC-SHA256 서명 방식
  ```
  Authorization: CEA algorithm=HmacSHA256, access-key={accessKey}, signed-date={timestamp}, signature={signature}
  ```
- **Rate Limit**: 분당 50회 제한 (RateLimiter 클래스로 자동 관리)
- **페이징**: nextToken 기반 페이징 처리

#### DB 스키마 (supabase/migrations/012_add_coupang_tables.sql)
- `coupang_credentials` - API 인증 정보 (vendor_id, access_key, secret_key)
- `coupang_products` - 상품 정보
- `coupang_product_options` - 상품 옵션 (vendorItemId 기준)
- `coupang_inventory` - 재고 정보
- `coupang_sync_logs` - 동기화 로그

#### 주문 매핑
- `orders` 테이블에 `shop_cd = 'coupang'`으로 저장
- `uniq = 'COUPANG-{orderId}-{vendorItemId}'` 형식

---

### 2. 교환/반품/AS 관리 시스템 개선

기존 교환/반품 시스템을 전면 개편하여 상태 관리 프로세스를 구현했습니다.

#### 구현 파일
- `apps/dashboard/app/features/returns/screens/returns-form.tsx` - 신규/수정 폼
- `apps/dashboard/app/features/returns/screens/returns-list.tsx` - 목록 화면 개선

#### 상태 프로세스
```
접수(received) → 수거예정(pickup_scheduled) → 수거완료(pickup_completed)
→ 검수중(inspecting) → 처리중(processing) → 발송완료(shipped) / 환불완료(refunded)
→ 완료(completed)
```

#### DB 스키마 (supabase/migrations/011_update_returns_exchanges.sql)
- `returns_exchanges` 테이블 구조 개선
- `return_status_history` 테이블 추가 (상태 변경 이력)
- `return_items` 테이블 (반품 상품 목록)

---

### 3. 재고 이력 조회 기능

재고 변동 이력을 조회할 수 있는 화면을 추가했습니다.

#### 구현 파일
- `apps/dashboard/app/features/inventory/screens/inventory-history.tsx`
- `apps/dashboard/app/features/inventory/screens/inventory.tsx` (개선)

#### DB 스키마 (supabase/migrations/010_add_inventory_history.sql)
- `inventory_history` 테이블 - 재고 변동 이력 저장

---

### 4. 사이드바 네비게이션 개선

대시보드 사이드바를 개선하여 새로운 메뉴들을 추가했습니다.

#### 수정 파일
- `apps/dashboard/app/features/users/components/dashboard-sidebar.tsx`

#### 추가된 메뉴
- 외부 연동 > 쿠팡
- 재고 > 재고 이력
- 교환/반품/AS (개선)

---

### 5. 라우트 업데이트

#### 수정 파일
- `apps/dashboard/app/routes.ts`

#### 추가된 라우트
```typescript
// 쿠팡 API
/api/integrations/coupang/auth/save
/api/integrations/coupang/sync-orders
/api/integrations/coupang/sync-products
/api/integrations/coupang/sync-inventory

// 대시보드 화면
/dashboard/integrations/coupang
/dashboard/inventory-history
/dashboard/returns (개선)
```

---

## 커밋 정보

```
commit a7e96d3
Author: inkyo
Date: 2026-01-02

feat: 쿠팡 로켓그로스 연동 및 교환/반품/AS 관리 시스템 추가

- 쿠팡 로켓그로스 API 연동 구현
  - HMAC-SHA256 인증 및 Rate Limiter (분당 50회)
  - 주문/상품/재고 동기화 API
  - 연동 관리 UI 화면
- 교환/반품/AS 관리 시스템 개선
  - 상태 관리 프로세스 구현 (접수→수거→검수→처리→완료)
  - 상태 변경 이력 저장
- 재고 이력 조회 화면 추가
- 사이드바 네비게이션 개선
```

---

### 6. 쿠팡 상품/옵션/재고 동기화 개선 (오후)

상품 옵션 동기화가 안 되는 문제를 해결하고, 전체적인 연동 로직을 개선했습니다.

#### 문제점 및 해결
1. **상품 목록 API가 items 배열 미반환**
   - 쿠팡 상품 목록 API는 `items: []` 빈 배열 반환
   - 옵션 정보는 상세 API에서만 포함됨
   - 해결: 상세 API에서 옵션을 `upsert`로 처리

2. **상세 API에서 update만 사용**
   - 기존: `.update()` 사용 → 옵션 레코드 없으면 무시
   - 개선: `.upsert()` 사용 → INSERT 또는 UPDATE

#### 새로 추가된 기능

**판매방식 구분**
- `ROCKET_GROWTH` (로켓그로스) - 쿠팡 물류센터
- `MARKETPLACE` (판매자배송) - 자체 배송

**로켓그로스 전용 창고**
```sql
INSERT INTO warehouses (warehouse_code, warehouse_name, warehouse_type)
VALUES ('WH-COUPANG-RG', '쿠팡 로켓그로스', '3pl');
```

**inventory_locations 연동**
- SKU 매핑된 옵션만 통합 재고 시스템에 반영
- 재고 변동 시 `inventory_history`에 이력 기록

**자동 SKU 매핑**
- 상품 동기화 시 `external_vendor_sku` → `products.sku` 자동 매핑

#### UI 개선
- **상품 목록**: 아코디언 UI로 옵션별 상세 표시
  - 옵션명, 판매방식 배지, 외부SKU, SKU 연결 상태, 재고, 판매가
- **재고 목록**: 판매방식 배지, SKU 매핑 통계 카드

#### 구현 파일
- `supabase/migrations/013_enhance_coupang_options.sql`
- `apps/dashboard/app/features/integrations/lib/coupang.server.ts`
- `apps/dashboard/app/features/integrations/api/coupang-sync-products.tsx`
- `apps/dashboard/app/features/integrations/api/coupang-sync-inventory.tsx`
- `apps/dashboard/app/features/integrations/screens/coupang-products.tsx`
- `apps/dashboard/app/features/integrations/screens/coupang-inventory.tsx`

#### 커밋

```
commit 98fb61e
Author: inkyo
Date: 2026-01-02

feat: 쿠팡 상품/옵션/재고 동기화 개선

- 상품 옵션 동기화 수정 (상세 API에서 upsert 방식으로 변경)
- 로켓그로스 + 판매자배송 둘 다 동기화 지원
- fulfillment_type 컬럼 추가 및 판매방식 배지 표시
- 로켓그로스 전용 창고 (WH-COUPANG-RG) 추가
- inventory_locations 연동 및 재고 이력 기록
- 상품 목록 아코디언 UI (옵션별 상세 표시)
- 자동 SKU 매핑 (external_vendor_sku → products.sku)
```

---

## 다음 작업 예정

1. ~~쿠팡 연동 테스트 (실제 API 키로 연결 확인)~~ ✅ 완료
2. ~~쿠팡 상품과 내부 SKU 매핑 기능~~ ✅ 자동 매핑 구현 완료
3. 수동 SKU 매핑 UI (다이얼로그로 내부 SKU 검색/선택)
4. 재고 자동 동기화 (cron job)
5. 교환/반품 알림톡 발송 연동
